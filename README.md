# ãƒŠã‚¤ãƒˆãƒ¯ãƒ¼ã‚¯åº—èˆ—å‘ã‘é¡§å®¢ç®¡ç†CRM

ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆå¯¾å¿œã®LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£æºCRMã€‚Cloudflare D1 + Hono + TypeScriptã§æ§‹ç¯‰ã€‚

## ğŸ¯ ä¸»ãªæ©Ÿèƒ½

### âœ… å®Ÿè£…æ¸ˆã¿

- **ãƒãƒ«ãƒãƒ†ãƒŠãƒ³ãƒˆ**: åº—èˆ—ã”ã¨ã«å®Œå…¨åˆ†é›¢ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ç®¡ç†
- **èªè¨¼ã‚·ã‚¹ãƒ†ãƒ **: ã‚»ãƒƒã‚·ãƒ§ãƒ³ãƒ™ãƒ¼ã‚¹ã®èªè¨¼ï¼ˆManager/Cast 2ã¤ã®ãƒ­ãƒ¼ãƒ«ï¼‰
- **LINE Webhook**: ç½²åæ¤œè¨¼ã€ç™»éŒ²ã‚³ãƒ¼ãƒ‰å‡¦ç†ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸å—ä¿¡
- **é¡§å®¢ç®¡ç†**: CRUDã€æ¥åº—å±¥æ­´ã€ã‚¿ã‚°ã€ãƒ¡ãƒ¢
- **ç™»éŒ²ã‚³ãƒ¼ãƒ‰**: ã‚­ãƒ£ã‚¹ãƒˆåˆ¥ã®æ™‚é™ä»˜ãç™»éŒ²ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
- **ToDoè‡ªå‹•ç”Ÿæˆ**: Cloudflare Cron (7/14/30æ—¥ãƒ•ã‚©ãƒ­ãƒ¼ã‚¢ãƒƒãƒ—)
- **ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡**: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€å¤‰æ•°ç½®æ›ã€ã‚¬ãƒ¼ãƒ‰ãƒ¬ãƒ¼ãƒ«ï¼ˆæ™‚é–“å¸¯ã€é »åº¦ï¼‰
- **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†**: åº—èˆ—ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ/ã‚­ãƒ£ã‚¹ãƒˆå€‹äººãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
- **ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†**: ã‚­ãƒ£ã‚¹ãƒˆè¿½åŠ /ç„¡åŠ¹åŒ–
- **ç›£æŸ»ãƒ­ã‚°**: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³è¨˜éŒ²ï¼ˆã‚¹ã‚­ãƒ¼ãƒã®ã¿ã€ãƒ­ã‚¸ãƒƒã‚¯ã¯æœªå®Ÿè£…ï¼‰

### ğŸš§ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ï¼ˆåŸºæœ¬ã®ã¿ï¼‰

- ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢
- ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤ºã®ã¿ï¼‰
- APIãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆè¨˜è¼‰ï¼ˆå®Ÿè£…ã¯åˆ¥é€”å¿…è¦ï¼‰

## ğŸ“Š æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

- **Runtime**: Cloudflare Workers/Pages
- **Framework**: Hono 4.x
- **Database**: Cloudflare D1 (SQLite)
- **ORM**: Drizzle ORM
- **Authentication**: ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†
- **Language**: TypeScript
- **Cron**: Cloudflare Triggers

## ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹

### ãƒ†ãƒ¼ãƒ–ãƒ«ä¸€è¦§

- `stores` - åº—èˆ—
- `users` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ (Manager/Cast)
- `sessions` - ã‚»ãƒƒã‚·ãƒ§ãƒ³
- `line_channels` - LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š
- `customers` - é¡§å®¢
- `visits` - æ¥åº—å±¥æ­´
- `todos` - é€ä¿¡ã™ã¹ãé¡§å®¢ãƒªã‚¹ãƒˆ
- `templates` - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
- `message_logs` - é€ä¿¡ãƒ­ã‚°
- `inbound_messages` - å—ä¿¡ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
- `registration_codes` - ç™»éŒ²ã‚³ãƒ¼ãƒ‰
- `audit_logs` - ç›£æŸ»ãƒ­ã‚°
- `todo_generation_rules` - ToDoç”Ÿæˆãƒ«ãƒ¼ãƒ«

## ğŸš€ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—

### 1. ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

```bash
npm install
```

### 2. ãƒ“ãƒ«ãƒ‰

```bash
npm run build
```

### 3. ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºï¼ˆé‡è¦ãªæ³¨æ„äº‹é …ï¼‰

**ç¾åœ¨ã€ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°å®Ÿè£…ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚** ä»¥ä¸‹ã®ä¿®æ­£ãŒå¿…è¦ã§ã™ï¼š

#### å•é¡Œç‚¹
- `app.route()` ã®ãƒã‚¹ãƒˆæ§‹é€ ãŒæ­£ã—ãå‹•ä½œã—ãªã„
- ã‚µãƒ–ãƒ«ãƒ¼ãƒˆã¸ã®ãƒ‘ã‚¹è»¢é€ãŒè¤‡é›‘

#### è§£æ±ºç­–ï¼ˆæ¨å¥¨ï¼‰
ã™ã¹ã¦ã®ãƒ«ãƒ¼ãƒˆã‚’ `src/index.tsx` ã«ç›´æ¥çµ±åˆã™ã‚‹ã‹ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ï¼š

```typescript
// å„ãƒ«ãƒ¼ãƒˆãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’ç›´æ¥ãƒã‚¦ãƒ³ãƒˆ
const db = createDb(c.env.DB);

app.post('/api/auth/login', async (c) => {
  // ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç›´æ¥è¨˜è¿°
});

app.get('/api/customers', async (c) => {
  // ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç›´æ¥è¨˜è¿°
});
```

### 4. ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç”¨ã®D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã¯ã€WranglerãŒè‡ªå‹•ã§ `.wrangler/state/v3/d1/` ä»¥ä¸‹ã«ä½œæˆã—ã¾ã™ã€‚

```bash
# é–‹ç™ºã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ï¼ˆè‡ªå‹•ã§ãƒ­ãƒ¼ã‚«ãƒ«D1ã‚’åˆæœŸåŒ–ï¼‰
npx wrangler pages dev dist --d1=DB --local --ip 0.0.0.0 --port 3000
```

åˆå›èµ·å‹•å¾Œã€åˆ¥ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã§ã‚·ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿æŠ•å…¥ï¼š

```bash
npm run db:seed
```

### 5. ãƒ†ã‚¹ãƒˆã‚¢ã‚«ã‚¦ãƒ³ãƒˆ

```
Manager: manager@example.com / password123
Cast 1:  cast1@example.com / password123
Cast 2:  cast2@example.com / password123
```

## ğŸ“¡ API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ

### èªè¨¼

- `POST /api/auth/login` - ãƒ­ã‚°ã‚¤ãƒ³
- `POST /api/auth/logout` - ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
- `GET /api/auth/me` - ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼å–å¾—

### é¡§å®¢ç®¡ç†

- `GET /api/customers` - é¡§å®¢ä¸€è¦§
- `GET /api/customers/:id` - é¡§å®¢è©³ç´°
- `PATCH /api/customers/:id` - é¡§å®¢æ›´æ–°
- `POST /api/customers/:id/visits` - æ¥åº—ç™»éŒ²
- `GET /api/customers/:id/visits` - æ¥åº—å±¥æ­´

### ç™»éŒ²ã‚³ãƒ¼ãƒ‰

- `POST /api/registration-codes` - ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
- `GET /api/registration-codes` - ã‚³ãƒ¼ãƒ‰ä¸€è¦§
- `GET /api/registration-codes/active` - æœ‰åŠ¹ãªã‚³ãƒ¼ãƒ‰

### ToDo

- `GET /api/todos` - ToDoä¸€è¦§
- `GET /api/todos/:id` - ToDoè©³ç´°
- `PATCH /api/todos/:id` - ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
- `GET /api/todos/today/list` - ä»Šæ—¥ã®ToDo

### ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸

- `POST /api/messages/send` - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
- `POST /api/messages/draft` - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ä¸‹æ›¸ãç”Ÿæˆ
- `GET /api/messages/logs` - é€ä¿¡å±¥æ­´

### ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ

- `GET /api/templates` - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§
- `POST /api/templates` - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ
- `PATCH /api/templates/:id` - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°
- `DELETE /api/templates/:id` - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‰Šé™¤

### ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ï¼ˆManagerã®ã¿ï¼‰

- `GET /api/users` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§
- `GET /api/users/casts` - ã‚­ãƒ£ã‚¹ãƒˆä¸€è¦§
- `POST /api/users` - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½œæˆ
- `PATCH /api/users/:id` - ãƒ¦ãƒ¼ã‚¶ãƒ¼æ›´æ–°

### Webhook

- `POST /webhook/line` - LINE Webhookå—ä¿¡

## ğŸ”§ LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š

### 1. LINE Developers

1. [LINE Developers Console](https://developers.line.biz/) ã§ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ã‚’ä½œæˆ
2. Messaging APIãƒãƒ£ãƒãƒ«ã‚’ä½œæˆ
3. ä»¥ä¸‹ã®æƒ…å ±ã‚’å–å¾—ï¼š
   - Channel Access Token
   - Channel Secret
   - Bot User ID

### 2. Webhook URLè¨­å®š

```
https://your-domain.pages.dev/webhook/line
```

### 3. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«LINEãƒãƒ£ãƒãƒ«ç™»éŒ²

```sql
UPDATE line_channels 
SET 
  channel_access_token = 'YOUR_ACTUAL_TOKEN',
  channel_secret = 'YOUR_ACTUAL_SECRET',
  bot_user_id = 'YOUR_BOT_USER_ID'
WHERE id = 'channel_001';
```

## â° Cronè¨­å®š

æ¯æ—¥12:00ã«ToDoè‡ªå‹•ç”Ÿæˆï¼š

```jsonc
// wrangler.jsonc
{
  "triggers": {
    "crons": ["0 12 * * *"]
  }
}
```

## ğŸ” ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£

- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¯ãƒƒã‚­ãƒ¼: HttpOnly, Secure, SameSite=Lax
- LINEç½²åæ¤œè¨¼: Web Crypto APIä½¿ç”¨
- ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰: bcrypt (rounds=10)
- RBAC: Manager/Castæ¨©é™åˆ†é›¢

## ğŸ“ TODOãƒªã‚¹ãƒˆ

### é«˜å„ªå…ˆåº¦

1. **ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ä¿®æ­£**: `src/index.tsx`ã®ãƒ«ãƒ¼ãƒˆå®šç¾©ã‚’å˜ç´”åŒ–
2. **ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢é©ç”¨**: å„APIãƒ«ãƒ¼ãƒˆã«èªè¨¼ãƒŸãƒ‰ãƒ«ã‚¦ã‚§ã‚¢ã‚’æ­£ã—ãé©ç”¨
3. **ç›£æŸ»ãƒ­ã‚°å®Ÿè£…**: CRUDæ“ä½œæ™‚ã®ãƒ­ã‚°è¨˜éŒ²
4. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**: çµ±ä¸€ã•ã‚ŒãŸã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹
5. **ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³

### ä¸­å„ªå…ˆåº¦

1. **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰**: ã‚­ãƒ£ã‚¹ãƒˆå‘ã‘ã‚¹ãƒãƒ›UI
   - é¡§å®¢ä¸€è¦§/æ¤œç´¢
   - é¡§å®¢è©³ç´°/ç·¨é›†
   - æ¥åº—ã‚¯ã‚¤ãƒƒã‚¯ç™»éŒ²
   - ToDoä¸€è¦§
   - ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é€ä¿¡
   - ç™»éŒ²ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
   
2. **ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ç”»é¢**: PCå‘ã‘ç®¡ç†ç”»é¢
   - ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰
   - ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†
   - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç®¡ç†
   - ãƒ«ãƒ¼ãƒ«è¨­å®š
   - é€ä¿¡ãƒ­ã‚°/ç›£æŸ»ãƒ­ã‚°

3. **ãƒ†ã‚¹ãƒˆ**: å˜ä½“ãƒ†ã‚¹ãƒˆã€çµ±åˆãƒ†ã‚¹ãƒˆ

### ä½å„ªå…ˆåº¦

1. èª•ç”Ÿæ—¥ToDo
2. ã‚¿ã‚°ç®¡ç†UI
3. çµ±è¨ˆ/ãƒ¬ãƒãƒ¼ãƒˆæ©Ÿèƒ½
4. é¡§å®¢æ‹…å½“ç§»ç®¡æ©Ÿèƒ½
5. ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå¤‰æ•°ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼

## ğŸ› æ—¢çŸ¥ã®å•é¡Œ

### 1. ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã‚¨ãƒ©ãƒ¼

**ç—‡çŠ¶**: Workers runtimeèµ·å‹•æ™‚ã« `Cannot read properties of undefined (reading 'map')` ã‚¨ãƒ©ãƒ¼

**åŸå› **: `app.route()` ã®ãƒã‚¹ãƒˆã¨ã‚µãƒ–ãƒ«ãƒ¼ãƒˆã¸ã®ãƒ‘ã‚¹è»¢é€

**å¯¾ç­–**: 
- Option A: ã™ã¹ã¦ã®ãƒ«ãƒ¼ãƒˆã‚’`src/index.tsx`ã«ç›´æ¥è¨˜è¿°
- Option B: Honoã®`basePath`ã‚’ä½¿ã£ãŸæ­£ã—ã„ãƒã‚¦ãƒ³ãƒˆæ–¹æ³•ã«å¤‰æ›´

### 2. D1ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³

**ç—‡çŠ¶**: `wrangler d1 migrations apply` ãŒwrangler.jsoncã®bindingåã‚’èªè­˜ã—ãªã„

**å¯¾ç­–**: Wranglerã®è‡ªå‹•ã‚¹ã‚­ãƒ¼ãƒä½œæˆã«ä¾å­˜ï¼ˆé–‹ç™ºã‚µãƒ¼ãƒãƒ¼èµ·å‹•æ™‚ï¼‰

## ğŸ“š å‚è€ƒè³‡æ–™

- [Hono Documentation](https://hono.dev/)
- [Cloudflare D1](https://developers.cloudflare.com/d1/)
- [Drizzle ORM](https://orm.drizzle.team/)
- [LINE Messaging API](https://developers.line.biz/ja/docs/messaging-api/)

## ğŸ“„ ãƒ©ã‚¤ã‚»ãƒ³ã‚¹

MIT License

## ğŸ‘¥ é–‹ç™ºè€…å‘ã‘ãƒ¡ãƒ¢

### Cloudflare Workersåˆ¶ç´„

- Node.js APIã¯ä½¿ç”¨ä¸å¯ï¼ˆ`fs`, `path`, `crypto`ãªã©ï¼‰
- Webæ¨™æº–APIä½¿ç”¨ï¼ˆFetch API, Web Crypto APIï¼‰
- ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã¯D1ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹
- ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã¯è¦R2 Bucket

### Drizzle Tips

- `better-sqlite3` ã¯ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºã®ã¿
- æœ¬ç•ªã¯Cloudflare D1ï¼ˆè‡ªå‹•ã§åˆ‡ã‚Šæ›¿ã‚ã‚‹ï¼‰
- ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¯ `drizzle-kit generate`

### ãƒ‡ãƒãƒƒã‚°

```bash
# PM2ãƒ­ã‚°
pm2 logs nightwork-crm --nostream

# Wranglerãƒ­ã‚°
tail -f /home/user/.config/.wrangler/logs/wrangler-*.log
```

## ğŸ‰ å®Œæˆå¾Œã®æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

1. ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ä¿®æ­£
2. ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰UIã®å®Ÿè£…
3. æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ (Cloudflare Pages)
4. LINEå…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆé€£æºãƒ†ã‚¹ãƒˆ
5. å®Ÿåº—èˆ—ã§ã®ãƒ™ãƒ¼ã‚¿ãƒ†ã‚¹ãƒˆ

---

**Status**: MVP Backend Completed (Routing Issue Needs Fix)
**Last Updated**: 2025-12-18
